name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - '.env.example'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: 22
          script: |
            echo "========================================="
            echo "Starting Deployment to AWS EC2"
            echo "========================================="
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
            mkdir -p /home/ubuntu/ecommerce
            cd /home/ubuntu/ecommerce
            
            # Git ì €ì¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
            if [ -d .git ]; then
              echo "Pulling latest code from GitHub..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # .env íŒŒì¼ ì¡´ì¬ í™•ì¸
            if [ ! -f .env ]; then
              echo "âŒ ERROR: .env file not found!"
              echo "Please create .env file with production settings"
              exit 1
            fi
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose down
            
            echo "Building Docker images..."
            docker-compose build backend
            
            echo "Starting containers..."
            docker-compose up -d
            
            echo "â³ Waiting for services to start..."
            sleep 15
            
            echo "========================================="
            echo "Container Status:"
            echo "========================================="
            docker-compose ps
            
            echo "========================================="
            echo "Backend Logs (last 30 lines):"
            echo "========================================="
            docker-compose logs --tail=30 backend
            
            echo "========================================="
            echo "Health Check:"
            echo "========================================="
            sleep 10
            curl -f http://localhost:8080/health || echo "âš ï¸ Health check failed"
            
            echo "ğŸ§¹ Cleaning up unused Docker images..."
            docker image prune -f
            
            echo "========================================="
            echo "âœ… Deployment Completed Successfully!"
            echo "========================================="